(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
"use strict";var OAK=OAK||{};OAK.gameResize=function(){},OAK.Engine=function(){function e(){t.canvas&&(t.preview[0]=t.canvas.viewportWidth=canvas.width,t.preview[1]=t.canvas.viewportHeight=canvas.height,OAK.gameResize())}this.canvas=null,this.preview=[512,512],this.curShader="defolt",this.shaders={defolt:{}},this.shaderProgram=null,this.models={},this.textures={},this.renables=[],this.efects=[],this.camera=new OAK.Camera,this.lights=new OAK.Lights,this.tReady=0,this.onload=null,this.keysDown={},this.keysUp={};var t=this;e(),document.addEventListener("keydown",function(e){t.keyPressed(e)}),document.addEventListener("keyup",function(e){t.keyReleased(e)}),window.addEventListener("resize",e,!0)},OAK.Engine.prototype.constructor=OAK.Engine,OAK.Engine.prototype.onLoaded=function(e){this.onload=e,this.onloadToDo=!0},OAK.Engine.prototype.onKey=function(e,t,r){this.keysDown[e]=t,this.keysUp[e]=r},OAK.Engine.prototype.keyPressed=function(e){var t=e.keyCode;this.keysDown[t]&&this.keysDown[t](),e.preventDefault()},OAK.Engine.prototype.keyReleased=function(e){var t=e.keyCode;this.keysUp[t]&&(this.keysUp[t](),e.preventDefault())},OAK.Engine.prototype.selectCanvas=function(e){if(this.canvas)throw"WebGL allready initialised";try{this.canvas=e.getContext("experimental-webgl",{antialias:!0}),this.canvas||(this.canvas=e.getContext("experimental-webgl")),this.canvas||(this.canvas=e.getContext("webgl")),window.dispatchEvent(new Event("resize"))}catch(e){}if(!this.canvas)throw"We could not intitialise WebGL on your browser"},OAK.Engine.prototype.vertexShader=function(e){if(!e)throw"no vertex shader code";if(!this.canvas)throw"select canvas first";var t,r=this.canvas;if(t=r.createShader(r.VERTEX_SHADER),r.shaderSource(t,e),r.compileShader(t),!r.getShaderParameter(t,r.COMPILE_STATUS))throw"vertex shader compile faild: "+r.getShaderInfoLog(t);return this.shaders[this.curShader].vertex=t,t},OAK.Engine.prototype.fragmentShader=function(e){if(!e)throw"no vertex shader code";if(!this.canvas)throw"select canvas first";var t,r=this.canvas;if(t=r.createShader(r.FRAGMENT_SHADER),r.shaderSource(t,e),r.compileShader(t),!r.getShaderParameter(t,r.COMPILE_STATUS))throw"fragment shader compile faild: "+r.getShaderInfoLog(t);return this.shaders[this.curShader].fragment=t,t},OAK.Engine.prototype.selectShader=function(e){this.curShader=e,this.shaders[this.curShader]||(this.shaders[this.curShader]={}),this.shaders[this.curShader].program&&(this.shaderProgram=this.shaders[this.curShader].program,this.shaderProgram.select())},OAK.Engine.prototype.initShaders=function(){var e=this.canvas;if(!e)throw"canvas not selected";if(!this.shaders[this.curShader])throw"shaders not compiled for selection "+this.curShader;if(!this.shaders[this.curShader].fragment)throw" fragment shader not compiled for selection "+this.curShader;if(!this.shaders[this.curShader].vertex)throw" vertex shader not compiled for selection "+this.curShader;var t=this.shaders[this.curShader].fragment,r=this.shaders[this.curShader].vertex;this.shaderProgram=new Shader(e,r,t,["Pmatrix","Vmatrix","Mmatrix","Flights","Lmatrix","PmatrixLight","source_direction","sampler","samplerShadowMap","time","inv_trans"],["position","uv","normal"]),this.shaders[this.curShader].program=this.shaderProgram,e.uniform1i(this.shaderProgram.sampler,0),e.uniform1i(this.shaderProgram.samplerShadowMap,1);var a={x:5,y:7,z:5};a=V3Normalise(a),OAK.LIGHTDIR=[a.x,a.y,a.z],this.camera.light=a,this.camera.matCalctulate(),e.uniform3fv(this.shaderProgram.source_direction,OAK.LIGHTDIR),e.disable(e.DEPTH_TEST),e.enable(e.BLEND),e.clearDepth(1),e.enable(e.CULL_FACE),e.cullFace(e.BACK)},OAK.Engine.prototype.initShadersPackage=function(e){var t=this.canvas;if(!t)throw"canvas not selected";e.program=new Shader(t,this.vertexShader(e.vertex),this.fragmentShader(e.fragment),e.uniform,e.attribute),this.shaders[e.name]=e,this.shaderProgram=e.program,t.uniform1i(this.shaderProgram.sampler,0),t.uniform1i(this.shaderProgram.samplerShadowMap,1);var r={x:5,y:7,z:5};r=V3Normalise(r),OAK.LIGHTDIR=[r.x,r.y,r.z],this.camera.light=r,this.camera.matCalctulate(),t.uniform3fv(this.shaderProgram.source_direction,OAK.LIGHTDIR),t.disable(t.DEPTH_TEST),t.enable(t.BLEND),t.clearDepth(1),t.enable(t.CULL_FACE),t.cullFace(t.BACK)},OAK.Engine.prototype.loadTexture=function(e,t){var r=this.canvas,a=this,i=r.createTexture();i.image=new Image,i.image.onload=function(e){r.bindTexture(r.TEXTURE_2D,i),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!0),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,i.image),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.generateMipmap(r.TEXTURE_2D),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST_MIPMAP_LINEAR),r.bindTexture(r.TEXTURE_2D,null),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,i),a.tReady--},a.tReady++,i.image.src=t,a.textures[e]=i},OAK.Engine.prototype.loadModel=function(e,t){var r=null;r="string"==typeof t||t instanceof String?JSON.parse(t):t;var a=new OAK.Mesh(this.canvas);a.SetMesh(r.vertices,r.textcords,r.normals,r.indices),this.models[e]=r,this.models[e].mesh=a;this.canvas},OAK.framecount=0,OAK.framelast=0,OAK.framerate=0,OAK.bindTexture=0,OAK.bindTextureCount=0,setInterval(function(){OAK.framerate=OAK.framecount-OAK.framelast,OAK.framelast=OAK.framecount},1e3),OAK.Engine.prototype.render=function(){var e=this;if(this.tReady<1){this.onloadToDo&&(this.onload(),this.onloadToDo=!1),OAK.framecount+=1;var t=this.canvas,r=this.camera,a=null;if(this.shaders.shadow){if(!this.texture_rtt){a=this.fb=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,a);var i=this.rb=t.createRenderbuffer();t.bindRenderbuffer(t.RENDERBUFFER,i),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,1024,1024),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,i);var s=this.texture_rtt=t.createTexture();t.bindTexture(t.TEXTURE_2D,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1024,1024,0,t.RGBA,t.UNSIGNED_BYTE,null),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,s,0),t.bindTexture(t.TEXTURE_2D,null),t.bindFramebuffer(t.FRAMEBUFFER,null)}t.bindFramebuffer(t.FRAMEBUFFER,this.fb),this.selectShader("shadow");var n=this.shaderProgram;t.viewport(0,0,1024,1024),t.clearColor(1,0,0,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.uniformMatrix4fv(n.Pmatrix,!1,r.getLightProj()),t.uniformMatrix4fv(n.Lmatrix,!1,r.getLight());for(var h in this.renables)if(this.renables.hasOwnProperty(h))for(var o=this.renables[h],c=0;c<o.length;c++)o[c].Draw(n);t.bindFramebuffer(t.FRAMEBUFFER,null)}t.clearColor(0,0,0,0),t.viewport(0,0,this.preview[0],this.preview[1]),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.enable(t.DEPTH_TEST),t.enable(t.BLEND),t.depthFunc(t.LEQUAL),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA);for(var h in this.renables)if(this.renables.hasOwnProperty(h)){this.selectShader(h);var d=this.renables[h];(n=this.shaderProgram).time&&t.uniform1f(n.time,OAK.framecount/10),t.uniformMatrix4fv(n.Pmatrix,!1,r.getProj()),t.uniformMatrix4fv(n.Vmatrix,!1,r.getMat()),t.uniformMatrix4fv(n.PmatrixLight,!1,r.getLightProj()),t.uniformMatrix4fv(n.Lmatrix,!1,r.getLight()),this.texture_rtt&&(t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,this.texture_rtt)),this.lights.Draw(t,n);for(c=0;c<d.length;c++)d[c].Draw(n)}if(this.efects.length>0){this.selectShader("efects"),n=this.shaderProgram,t.uniformMatrix4fv(n.Pmatrix,!1,r.getProj()),t.uniformMatrix4fv(n.Vmatrix,!1,r.getMat()),t.cullFace(t.BACK);for(c=0;c<this.efects.length;c++)this.efects[c].Draw(n)}t.flush()}window.requestAnimationFrame(function(){e.render()})},OAK.Engine.prototype.getCamera=function(e,t){return this.camera},OAK.Engine.prototype.getObject=function(e,t,r,a,i){var s=new OAK.Rendable(this.canvas,this.models[t].mesh,this.textures[r],e,0,i);return a&&this.addRender(s),s},OAK.Engine.prototype.getAObject=function(e,t,r,a,i){for(var s=[],n=[],h=0;h<t.length;h++)s.push(this.models[t[h]].mesh);for(var o=0;o<r.length;o++)n.push(this.textures[r[o]]);var c=new OAK.ARendable(this.canvas,s,n,e,0,i);return a&&this.addRender(c),c},OAK.Engine.prototype.addRender=function(e){var t=e.shaderid;this.renables[t]||(this.renables[t]=[]),this.renables[t].push(e),this.renables[t]=this.renables[t].sort(function(e,t){return e.position.y>t.position.y?1:e.position.y<t.position.y?-1:0})},OAK.Engine.prototype.getEfect=function(e,t,r,a){var i=new OAK.Rendable(this.canvas,this.models[t].mesh,this.textures[r],e,0);return a&&this.efects.push(i),i},OAK.Engine.prototype.getObjectsStatic=function(e,t,r,a,i,s){for(var n={vertices:[],textcords:[],normals:[],indices:[]},h=this.models[r],o=0;o<t.length;o++)n.vertices=n.vertices.concat(h.vertices),n.textcords=n.textcords.concat(h.textcords),n.normals=n.normals.concat(h.normals),n.indices=n.indices.concat(h.indices);for(o=0;o<t.length;o++){for(c=0;c<h.indices.length;c++)n.indices[o*h.indices.length+c]+=o*h.vertices.length/3;for(var c=0;c<h.vertices.length;c++)n.vertices[o*h.vertices.length+c]=c%3==0?parseFloat(n.vertices[o*h.vertices.length+c])+t[o].x:c%3==1?parseFloat(n.vertices[o*h.vertices.length+c])+t[o].y:parseFloat(n.vertices[o*h.vertices.length+c])+t[o].z}var d=new OAK.Mesh(this.canvas);d.SetMesh(n.vertices,n.textcords,n.normals,n.indices);var l=new OAK.Rendable(this.canvas,d,this.textures[a],e,0,s);return i&&this.addRender(l),l},OAK.Engine.prototype.remObject=function(e){for(var t in this.renables)this.renables.hasOwnProperty(t)&&(this.renables[t]=this.renables[t].filter(function(t){return t!=e}));this.efects=this.efects.filter(function(t){return t!=e})};

},{}]},{},[1]);
